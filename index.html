<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <!-- Tambahkan CSS untuk Leaflet (dari CDN jika file lokal tidak tersedia) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        /* Styling untuk search bar internal */
        .leaflet-control-search {
            position: relative;
        }
        
        .search-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 200px;
        }
        
        /* Styling untuk search bar kustom */
        .custom-search-container {
            position: absolute;
            top: 100px;
            left: 10px;
            z-index: 9999;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .custom-search-input {
            width: 250px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .custom-search-button {
            padding: 8px 15px;
            background: #007cff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .custom-search-button:hover {
            background: #0056b3;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 10000;
        }
        
        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        </style>
        <title>Peta Rumah Ibadah Surabaya</title>
        <!-- Google Maps API Script -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2lwdS5wB2neO4JcEkSYjyvI9t1K4KYIs&libraries=places"></script>
        <!-- Leaflet dari CDN jika file lokal tidak tersedia -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    </head>
    <body>
        <!-- Search Bars untuk Koordinat dan Alamat (tetap seperti semula) -->
        <div style="position: absolute; top: 10px; left: 10px; z-index: 9999; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            <input type="text" id="longitude" placeholder="Longitude" style="width: 120px; margin-right: 5px; padding: 5px;">
            <input type="text" id="latitude" placeholder="Latitude" style="width: 120px; margin-right: 5px; padding: 5px;">
            <button onclick="searchByCoordinates()" style="padding: 5px 10px; background: #007cff; color: white; border: none; border-radius: 4px; cursor: pointer;">Search by Coordinates</button>
        </div>
        
        <div style="position: absolute; top: 50px; left: 10px; z-index: 9999; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            <input type="text" id="address" placeholder="Enter Address" style="width: 200px; margin-right: 5px; padding: 5px;">
            <button onclick="searchByAddressGoogle()" style="padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Search by Address</button>
        </div>

        <!-- Search Bar Kustom untuk Rumah Ibadah -->
        <div class="custom-search-container">
            <div style="position: relative;">
                <input type="text" id="customSearchInput" class="custom-search-input" placeholder="Cari nama rumah ibadah..." autocomplete="off">
                <button onclick="performCustomSearch()" class="custom-search-button">Cari</button>
                <div id="searchResults" class="search-results"></div>
            </div>
            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                Contoh: Masjid Al-Akbar, Gereja Katedral, dsb.
            </div>
        </div>

        <!-- Map container -->
        <div id="map"></div>

        <!-- Load semua script yang diperlukan -->
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/RumahIbadah_1.js"></script>

        <script>
        // Variabel global untuk menyimpan marker yang sedang di-highlight
        var highlightLayer;
        var currentSearchMarker = null;
        var allFeatures = []; // Array untuk menyimpan semua features untuk pencarian
        
        function highlightFeature(e) {
            highlightLayer = e.target;
            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: '#ffff00',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: '#ffff00',
                fillOpacity: 1
              });
            }
        }

        var map = L.map('map', {
            zoomControl:false, maxZoom:28, minZoom:1
        });

        // Set initial view ke Surabaya
        map.setView([-7.2575, 112.7521], 12);

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});

        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(function() {
                    popup.update();
                }, 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        
        // Cek apakah L.control.locate tersedia
        if (typeof L.control.locate !== 'undefined') {
            L.control.locate({locateOptions: {maxZoom: 19}}).addTo(map);
        }

        // Cek apakah L.Control.Measure tersedia
        if (typeof L.Control !== 'undefined' && L.Control.Measure) {
            var measureControl = new L.Control.Measure({
                position: 'topleft',
                primaryLengthUnit: 'meters',
                secondaryLengthUnit: 'kilometers',
                primaryAreaUnit: 'sqmeters',
                secondaryAreaUnit: 'hectares'
            });
            measureControl.addTo(map);
            document.getElementsByClassName('leaflet-control-measure-toggle')[0].innerHTML = '';
            document.getElementsByClassName('leaflet-control-measure-toggle')[0].className += ' fas fa-ruler';
        }

        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }

        map.createPane('pane_Positron_0');
        map.getPane('pane_Positron_0').style.zIndex = 400;

        var layer_Positron_0 = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            pane: 'pane_Positron_0',
            opacity: 1.0,
            attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 20
        });
        layer_Positron_0;
        map.addLayer(layer_Positron_0);

        function pop_RumahIbadah_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                },
                mouseover: highlightFeature,
            });

            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">Nama</th>\
                        <td>' + (feature.properties['NAMA'] !== null ? autolinker.link(String(feature.properties['NAMA']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Alamat</th>\
                        <td>' + (feature.properties['ALAMAT'] !== null ? autolinker.link(String(feature.properties['ALAMAT']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Koordinat</th>\
                        <td>' + (feature.properties['KOORDINAT'] !== null ? autolinker.link(String(feature.properties['KOORDINAT']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Jenis Rumah Ibadah</th>\
                        <td>' + (feature.properties['JENIS_TEMP'] !== null ? autolinker.link(String(feature.properties['JENIS_TEMP']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Kecamatan</th>\
                        <td>' + (feature.properties['KECAMATAN'] !== null ? autolinker.link(String(feature.properties['KECAMATAN']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Kelurahan</th>\
                        <td>' + (feature.properties['KELURAHAN'] !== null ? autolinker.link(String(feature.properties['KELURAHAN']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Telepon</th>\
                        <td>' + (feature.properties['TELEPON'] !== null ? autolinker.link(String(feature.properties['TELEPON']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['Foto'] !== null ? '<img src="images/' + String(feature.properties['Foto']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '" style="max-width: 200px; height: auto;">' : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_RumahIbadah_1_0(feature) {
            // Gunakan ikon default jika file ikon tidak tersedia
            var iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
            var iconSize = [25, 41];
            var iconAnchor = [12, 41];
            
            switch(String(feature.properties['JENIS_TEMP'])) {
                case 'Gereja':
                    // Coba gunakan ikon kustom, fallback ke default
                    try {
                        iconUrl = 'markers/RumahIbadah_Gereja.svg';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
                case 'Klenteng':
                    try {
                        iconUrl = 'legend/RumahIbadah_1_Klenteng1.png';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
                case 'Masjid':
                    try {
                        iconUrl = 'legend/RumahIbadah_1_Masjid2.png';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
                case 'Musholla':
                    try {
                        iconUrl = 'legend/RumahIbadah_1_Musholla3.png';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
                case 'Pura':
                    try {
                        iconUrl = 'markers/RumahIbadah_hindu.svg';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
                case 'Vihara':
                    try {
                        iconUrl = 'markers/RumahIbadah_1.svg';
                        iconSize = [15.2, 15.2];
                        iconAnchor = [7.6, 7.6];
                    } catch(e) {
                        iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                    }
                    break;
            }
            
            return {
                pane: 'pane_RumahIbadah_1',
                rotationAngle: 0.0,
                rotationOrigin: 'center center',
                icon: L.icon({
                    iconUrl: iconUrl,
                    iconSize: iconSize,
                    iconAnchor: iconAnchor,
                    popupAnchor: [0, -iconAnchor[1]]
                }),
                interactive: true,
            };
        }

        map.createPane('pane_RumahIbadah_1');
        map.getPane('pane_RumahIbadah_1').style.zIndex = 401;
        map.getPane('pane_RumahIbadah_1').style['mix-blend-mode'] = 'normal';

        // Cek apakah data json_RumahIbadah_1 tersedia
        var geoJsonData = null;
        if (typeof json_RumahIbadah_1 !== 'undefined') {
            geoJsonData = json_RumahIbadah_1;
        } else {
            // Data dummy untuk testing jika file data tidak tersedia
            geoJsonData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "NAMA": "Masjid Al-Akbar Surabaya",
                            "ALAMAT": "Jl. Masjid Al Akbar Timur No.1",
                            "KOORDINAT": "-7.269722, 112.768611",
                            "JENIS_TEMP": "Masjid",
                            "KECAMATAN": "Sukolilo",
                            "KELURAHAN": "Dukuh Sutorejo",
                            "TELEPON": "(031) 5928800"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [112.768611, -7.269722]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "NAMA": "Gereja Katedral Hati Kudus Yesus",
                            "ALAMAT": "Jl. Kepanjen No.2",
                            "KOORDINAT": "-7.258056, 112.743056",
                            "JENIS_TEMP": "Gereja",
                            "KECAMATAN": "Krembangan",
                            "KELURAHAN": "Kemayoran",
                            "TELEPON": "(031) 5343814"
                        },
                        "geometry": {
                            "type": "Point",
                            "coordinates": [112.743056, -7.258056]
                        }
                    }
                ]
            };
        }

        var layer_RumahIbadah_1 = new L.geoJson(geoJsonData, {
            attribution: '',
            interactive: true,
            dataVar: 'json_RumahIbadah_1',
            layerName: 'layer_RumahIbadah_1',
            pane: 'pane_RumahIbadah_1',
            onEachFeature: function(feature, layer) {
                // Simpan semua features untuk keperluan pencarian
                allFeatures.push({feature: feature, layer: layer});
                // Panggil fungsi popup
                pop_RumahIbadah_1(feature, layer);
            },
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_RumahIbadah_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_RumahIbadah_1);
        map.addLayer(layer_RumahIbadah_1);

        // Photon Control (jika tersedia)
        const url = {"Nominatim": "https://nominatim.openstreetmap.org/search?format=geojson&addressdetails=1&",
        "BAN": "https://api-adresse.data.gouv.fr/search/?"}
        if (typeof L.control.photon !== 'undefined') {
            var photonControl = L.control.photon({
                url: url["Nominatim"],
                feedbackLabel: '',
                position: 'topright',
                includePosition: true,
                initial: true,
            }).addTo(map);
            photonControl._container.childNodes[0].style.borderRadius="10px";
        }

        // Layer control
        var overlaysTree = [
            {label: 'Rumah Ibadah<br /><table><tr><td style="text-align: center;">üïå</td><td>Masjid</td></tr><tr><td style="text-align: center;">‚õ™</td><td>Gereja</td></tr><tr><td style="text-align: center;">üèõÔ∏è</td><td>Pura</td></tr><tr><td style="text-align: center;">üèØ</td><td>Vihara</td></tr><tr><td style="text-align: center;">üèÆ</td><td>Klenteng</td></tr><tr><td style="text-align: center;">üïå</td><td>Musholla</td></tr></table>', layer: layer_RumahIbadah_1},
            {label: "Positron", layer: layer_Positron_0, radioGroup: 'bm' }
        ];
        
        if (typeof L.control.layers.tree !== 'undefined') {
            var lay = L.control.layers.tree(null, overlaysTree, {
                collapsed: true,
            });
            lay.addTo(map);
        }

        setBounds();

        // ===== FUNGSI-FUNGSI PENCARIAN YANG DIPERBAIKI =====

        // Fungsi pencarian berdasarkan koordinat (tetap seperti semula)
        function searchByCoordinates() {
            var longitude = parseFloat(document.getElementById('longitude').value);
            var latitude = parseFloat(document.getElementById('latitude').value);
            
            if (!isNaN(longitude) && !isNaN(latitude)) {
                var latLng = L.latLng(latitude, longitude);
                map.setView(latLng, 16);
                
                // Hapus marker pencarian sebelumnya jika ada
                if (currentSearchMarker) {
                    map.removeLayer(currentSearchMarker);
                }
                
                currentSearchMarker = L.marker(latLng, {
                    icon: L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(map).bindPopup('Koordinat: ' + latitude.toFixed(6) + ', ' + longitude.toFixed(6)).openPopup();
            } else {
                alert('Masukkan koordinat yang valid (angka).');
            }
        }

        // Fungsi pencarian berdasarkan alamat menggunakan Google Maps
        function searchByAddressGoogle() {
            var address = document.getElementById('address').value.trim();
            if (address) {
                if (typeof google !== 'undefined' && google.maps) {
                    var geocoder = new google.maps.Geocoder();
                    geocoder.geocode({'address': address + ', Surabaya, Indonesia'}, function(results, status) {
                        if (status === 'OK' && results.length > 0) {
                            var latLng = L.latLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                            map.setView(latLng, 16);
                            
                            // Hapus marker pencarian sebelumnya jika ada
                            if (currentSearchMarker) {
                                map.removeLayer(currentSearchMarker);
                            }
                            
                            currentSearchMarker = L.marker(latLng, {
                                icon: L.icon({
                                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34]
                                })
                            }).addTo(map).bindPopup('Alamat: ' + results[0].formatted_address).openPopup();
                        } else {
                            alert('Alamat tidak ditemukan: ' + status);
                        }
                    });
                } else {
                    alert('Google Maps API tidak tersedia.');
                }
            } else {
                alert('Masukkan alamat yang akan dicari.');
            }
        }

        // ===== FUNGSI PENCARIAN KUSTOM UNTUK RUMAH IBADAH =====
        
        function performCustomSearch() {
            var searchTerm = document.getElementById('customSearchInput').value.trim();
            if (searchTerm) {
                searchRumahIbadah(searchTerm);
                hideSearchResults();
            }
        }

        function searchRumahIbadah(searchTerm) {
            var found = false;
            var searchLower = searchTerm.toLowerCase();
            
            // Cari di semua features
            allFeatures.forEach(function(item) {
                var feature = item.feature;
                var layer = item.layer;
                var nama = feature.properties.NAMA ? feature.properties.NAMA.toLowerCase() : '';
                var alamat = feature.properties.ALAMAT ? feature.properties.ALAMAT.toLowerCase() : '';
                var jenis = feature.properties.JENIS_TEMP ? feature.properties.JENIS_TEMP.toLowerCase() : '';
                var kecamatan = feature.properties.KECAMATAN ? feature.properties.KECAMATAN.toLowerCase() : '';
                
                // Cek apakah search term cocok dengan nama, alamat, jenis, atau kecamatan
                if (nama.includes(searchLower) || 
                    alamat.includes(searchLower) || 
                    jenis.includes(searchLower) ||
                    kecamatan.includes(searchLower)) {
                    
                    // Pindah ke lokasi marker
                    var coordinates = feature.geometry.coordinates;
                    var latLng = L.latLng(coordinates[1], coordinates[0]);
                    map.setView(latLng, 17);
                    
                    // Buka popup
                    setTimeout(function() {
                        layer.openPopup();
                    }, 500);
                    
                    // Highlight marker sementara
                    if (layer.setStyle) {
                        layer.setStyle({fillColor: '#ff0000', fillOpacity: 1});
                        setTimeout(function() {
                            layer.setStyle({fillColor: '#3388ff', fillOpacity: 0.6});
                        }, 3000);
                    }
                    
                    found = true;
                    return; // Hentikan pencarian setelah menemukan hasil pertama
                }
            });
            
            if (!found) {
                alert('Rumah ibadah "' + searchTerm + '" tidak ditemukan. Coba kata kunci yang lebih spesifik.');
            }
        }

        // Fungsi untuk menampilkan suggestion saat mengetik
        function showSearchSuggestions(searchTerm) {
            var resultsContainer = document.getElementById('searchResults');
            var searchLower = searchTerm.toLowerCase();
            var suggestions = [];
            
            if (searchTerm.length < 2) {
                hideSearchResults();
                return;
            }
            
            // Cari maksimal 5 suggestions
            allFeatures.forEach(function(item) {
                if (suggestions.length >= 5) return;
                
                var feature = item.feature;
                var nama = feature.properties.NAMA || '';
                var alamat = feature.properties.ALAMAT || '';
                var jenis = feature.properties.JENIS_TEMP || '';
                var kecamatan = feature.properties.KECAMATAN || '';
                
                if (nama.toLowerCase().includes(searchLower) || 
                    alamat.toLowerCase().includes(searchLower) || 
                    jenis.toLowerCase().includes(searchLower) ||
                    kecamatan.toLowerCase().includes(searchLower)) {
                    
                    suggestions.push({
                        feature: feature,
                        layer: item.layer,
                        displayText: nama + ' (' + jenis + ')',
                        fullText: nama + ' - ' + alamat + ' (' + kecamatan + ')'
                    });
                }
            });
            
            if (suggestions.length > 0) {
                var html = '';
                suggestions.forEach(function(suggestion) {
                    html += '<div class="search-result-item" onclick="selectSuggestion(\'' + 
                           suggestion.feature.properties.NAMA.replace(/'/g, "\\'") + '\')">' +
                           '<strong>' + suggestion.displayText + '</strong><br>' +
                           '<small>' + suggestion.feature.properties.ALAMAT + '</small>' +
                           '</div>';
                });
                
                resultsContainer.innerHTML = html;
                resultsContainer.style.display = 'block';
            } else {
                hideSearchResults();
            }
        }

        function selectSuggestion(nama) {
            document.getElementById('customSearchInput').value = nama;
            searchRumahIbadah(nama);
            hideSearchResults();
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }

        // Event listeners untuk search input
        document.getElementById('customSearchInput').addEventListener('input', function(e) {
            showSearchSuggestions(e.target.value);
        });

        document.getElementById('customSearchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                performCustomSearch();
            }
            if (e.key === 'Escape') {
                hideSearchResults();
            }
        });

        // Sembunyikan dropdown ketika klik di luar
        document.addEventListener('click', function(e) {
            var searchContainer = document.querySelector('.custom-search-container');
            if (!searchContainer.contains(e.target)) {
                hideSearchResults();
            }
        });

        // Inisialisasi leaflet-search jika tersedia (sebagai backup)
        if (typeof L.Control.Search !== 'undefined') {
            try {
                var searchControl = new L.Control.Search({
                    layer: layer_RumahIbadah_1,
                    initial: false,
                    hideMarkerOnCollapse: true,
                    propertyName: 'NAMA',
                    position: 'topright',
                    textPlaceholder: 'Cari rumah ibadah...',
                    moveToLocation: function(latlng, title, map) {
                        map.setView(latlng, 17);
                    },
                    autoCollapse: true,
                    autoType: false,
                    minLength: 2
                });
                
                // Event listener untuk hasil pencarian
                searchControl.on('search:locationfound', function(e) {
                    e.layer.openPopup();
                });
                
                searchControl.addTo(map);
            } catch (error) {
                console.log('Leaflet Search plugin tidak tersedia atau error:', error);
            }
        }

        // Fungsi utilitas tambahan
        function clearAllSearchMarkers() {
            if (currentSearchMarker) {
                map.removeLayer(currentSearchMarker);
                currentSearchMarker = null;
            }
        }

        // Event listener untuk tombol Enter pada input koordinat dan alamat
        document.getElementById('longitude').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') searchByCoordinates();
        });

        document.getElementById('latitude').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') searchByCoordinates();
        });

        document.getElementById('address').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') searchByAddressGoogle();
        });

        // Fungsi untuk mendapatkan statistik rumah ibadah
        function getRumahIbadahStats() {
            var stats = {};
            allFeatures.forEach(function(item) {
                var jenis = item.feature.properties.JENIS_TEMP || 'Tidak Diketahui';
                stats[jenis] = (stats[jenis] || 0) + 1;
            });
            return stats;
        }

        // Log statistik ke console (untuk debugging)
        setTimeout(function() {
            console.log('Statistik Rumah Ibadah:', getRumahIbadahStats());
            console.log('Total Rumah Ibadah:', allFeatures.length);
        }, 1000);

        </script>
    </body>
</html>